#!/usr/bin/env bash

export LOG_DIR=$(dirname "$0")/../log
export ERROR_LOG="${LOG_DIR}/${RAILS_ENV}.err.log"
export SKIP_FILE_WRITE="1"

bm_gems() {
  echo_bold "Bundled gems"
  echo ""
  bundle exec derailed bundle:mem 2> ${ERROR_LOG} | head -n 1 | sed -r 's/TOP: (.*)/\1/'
  echo ""
}

bm_objects() {
  echo_bold "$1: Objects"
  echo ""
  RAILS_ENV=profiling TEST_COUNT=10 PATH_TO_HIT="$2" bundle exec derailed exec perf:objects 2> ${ERROR_LOG} | head -n 5
  echo ""
}

bm_ips() {
  echo_bold "$1: IPS"
  echo ""
  RAILS_ENV=profiling TEST_COUNT=1_000 PATH_TO_HIT="$2" bundle exec derailed exec perf:ips 2> ${ERROR_LOG}
  echo ""
}

bm_path() {
  bm_objects "$1" "$2"
  bm_ips "$1" "$2"
}

echo_bold() {
  echo -e "\e[1m$1\e[0m"
}

bm_gems
bm_path "Search results page" "/en/search?q="
bm_path "Record page" "/en/record/123/abc.html"
